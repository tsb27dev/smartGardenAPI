name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: smartgarden
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: '.'
  PUBLISH_PATH: './publish'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Verify project structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Project files in SmartGardenApi:"
        ls -la ${{ env.PROJECT_PATH }}/ | grep -E "\.csproj|\.sln" || echo "No project files found"
        if [ ! -f "${{ env.PROJECT_PATH }}/SmartGardenApi.csproj" ]; then
          echo "ERROR: Project file not found at ${{ env.PROJECT_PATH }}/SmartGardenApi.csproj"
          ls -la ${{ env.PROJECT_PATH }}/
          exit 1
        fi
        echo "✓ Project file found!"

    - name: Restore dependencies
      run: dotnet restore "${{ env.PROJECT_PATH }}/SmartGardenApi.csproj"

    - name: Build Release
      run: dotnet build "${{ env.PROJECT_PATH }}/SmartGardenApi.csproj" --configuration Release --no-restore

    - name: Publish Release
      run: dotnet publish "${{ env.PROJECT_PATH }}/SmartGardenApi.csproj" --configuration Release --no-build --output ${{ env.PUBLISH_PATH }}

    - name: Verify publish output
      run: |
        echo "Publish directory contents:"
        ls -la ${{ env.PUBLISH_PATH }}

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ${{ env.PUBLISH_PATH }}

    - name: Deployment complete
      if: success()
      run: echo "✓ Successfully deployed to Azure App Service"
